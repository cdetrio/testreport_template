<!DOCTYPE html>
<html lang="en">
<head>
	<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<script src="jquery.dataTables.min.js"></script>
	<script src="dataTables.bootstrap.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="dataTables.bootstrap.min.css">

</head>

<style>
.modal-lg {
    width: 1600px;
}
.modal-dialog { width: 90%; }


</style>

<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-9" role="main">
				<h1>Test report</h1>
				<h2>Execution info</h2>
				<table class="table table-bordered" id="metadata">
				</table>

				<h2>Failure summary</h2>
				<table id="summary" class="table table-striped table-bordered" width="100%">
				</table>

				<h2>Execution results</h2>
				<table id="example" class="table table-striped table-bordered" width="100%">
				</table>
			</div>
			<div class="col-md-3" role="complementary"></div>
		</div>
	</div>
	<!-- Modal -->
	<div class="modal fade modal-lg" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	        <h4 class="modal-title" id="myModalLabel">Logs</h4>
	      </div>
	      <pre class="modal-body" id="modal-logs">

	      </pre>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	      </div>
	    </div>
	  </div>
	</div>




</body>
<script>

	function displayLog(url){

		  $("#modal-logs").load(url,function(result){
			  	//console.log(result);
		 		$('#myModal').modal({show:true});
			});
	}

utils = {

	/*
	* HTML-encoding
	*/
	html_encode : function (str){
		//Let the DOM do it for us. 
		var d = document.createElement('textarea');
		d.innerText = str;
		//Yes, I'm aware of 
		// http://stackoverflow.com/questions/1219860/html-encoding-in-javascript-jquery
		// I just don't agree. 
		return d.innerHTML;
	},
	/*
	* HTML Attribute encoding
	*/
	attr_encode : function (str){	
		x = document.createElement("x");
		x.setAttribute("b",str);
		var all = x.outerHTML;
		return all.substring(6,all.length-6);
	},
	/*
	* Dirty url-parsing of the url hash segment
	*/
	get_hash_params : function() {
		var retval = {}
		var query = window.location.hash.substring(1);
		var vars = query.split('&');
		for (var i = 0; i < vars.length; i++) {
			var pair = vars[i].split('=');
			retval[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1])
		}
		return retval;
	},
	/*
	* Creates an anchor-element from 'untrusted' link 'data'
	*/
	get_link : function(url, text){
		var a = document.createElement('a');
		a.setAttribute("href",url);
		a.text = text;
		a.setAttribute("target", "_blank");
		return a.outerHTML;
	},
	/*
	* Creates
	* <button type="button" class="btn btn-default">Default</button>
	*/
	get_button: function(onclick, text){
		var a = document.createElement('button');
		a.setAttribute("type","button");
		a.setAttribute("class","btn btn-primary btn-xs")
		a.textContent = text;
		a.setAttribute("onclick", onclick)
		return a.outerHTML;
	},

}

function recurseList(elem){
	if (typeof(elem) == 'string'){
		return "<li>"+utils.html_encode(elem)+"</li>"
	}
	return "<ul>" + elem.map(recurseList).join("\n")+"</ul>"
}

$(document).ready(function() {

	$.getJSON( "data.json", onData)
		.fail(function(){
				console.log("Failed");
				//Ok, try to get jsonp-data instead
				var script = document.createElement('script');
				script.src = "data.jsonp";
				document.head.appendChild(script);
			}
		);

});

/*
* Performs filtering on the "Execution Result" datatable
*/
function execfilter(str){
	$('#example').dataTable().api().search(str).draw();
}
function onData(data){

	overallresults = {
		results : {},
		clients : {"Testcase":0},
		cols : [{ "title": "Testcase"} ]
	}
	function addOverallResult(testcase, client, status){
		if (overallresults.results[testcase] == null){
			overallresults.results[testcase] = [testcase]
		}
		_tcase = overallresults.results[testcase]
		if (overallresults[client] == null)
		{
			overallresults[client] = overallresults.cols.length
			overallresults.cols.push({"title" : client});
		}
		_clientnum = overallresults[client]
		_tcase[_clientnum] = status
	}


	data = data["simulations"]
	var items = []
	var meta = []
	var testtype = "ethereum/consensus"; 
	var logfile_root = "simulations/ethereum:consensus"

	var TEST_REPO = "https://github.com/ethereum/tests/blob/develop/";

	for (var client in data){

		performed_test = data[client][testtype];

		if (!performed_test) continue;
		

		meta.push([client +" start time", performed_test.start]);
		meta.push([client +" end time", performed_test.end]);
		var href = logfile_root+'['+client+']/simulator.log';
		var u = "displayLog('"+href+"')";
		meta.push(["Simulator log file", '<a onclick="'+u+'">'+client+'</a>']);
		
		// ./tests/BlockchainTests/bcInvalidHeaderTest.json:ForkUncle
		// => BlockchainTests/bcInvalidHeaderTest.json:ForkUncle
		// link to => https://github.com/ethereum/tests/blob/develop/BlockchainTests/bcInvalidHeaderTest.json

		var x = performed_test.subresults.map(function(subresult){

			var fname = subresult.name;
			if(fname.startsWith("./tests/"))
			{
				fname = fname.substring(8);
			}
			addOverallResult(fname,client,subresult.success);
			return { 
				"filename" 	: fname,
			 	"status" 	: subresult.success,
				"client"	: client,
				"instance"	: subresult.details.instanceid,
				"message" 	: subresult.details.errors,
			}			
		});
		items = items.concat(x)
	}

	var linkToTestRepo = function(data){
			if(!data) { return ""};
			[file, tcase] = data.split(":")
			return utils.get_link(TEST_REPO+file, tcase);
	}
	var linkToTestRepoAndFilter = function(data){
			if(!data) { return ""};
			[file, tcase] = data.split(":")
			firstlink =  utils.get_link(TEST_REPO+file, tcase);
			secondlink = utils.get_button("javascript:execfilter('"+tcase+"')", "filter")
			return firstlink +"&nbsp;&nbsp;"+ secondlink
	}


   $('#example').DataTable( {
        data: items,
        pageLength: 100,
        columns: [
            { title: "Filename", data: "filename" ,
            	render: linkToTestRepo,
        },
            { title: "Status", data: "status" },
            { title: "Client", data: "client" },
            { title: "Log", data: "instance" , 
	           	render: function ( data, type, row ) {
     				   	if(!data) { return ""};
     				   	var href = logfile_root+"["+row.client+"]/client-"+data+".log"
            			var a = document.createElement('a');
            			//a.href = href;
            			a.setAttribute("onclick","displayLog('"+href+"')" );
            			a.text = data;
            			return a.outerHTML;
    			}},
            { title: "Message", data: "message", 
            	render: function ( data, type, row ) {
     				   if(!data) { return ""};
     				   return recurseList(data);

    			}, 
        },
        ],

        fnRowCallback: function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
        	var _s = {"false" : "danger", "true": "success"}[aData.status];
        	$(nRow).addClass( _s || "info")
			return nRow;
		},

    });

    $("#metadata").DataTable({
    	data : meta,
    	columns: [{ title: "Key" },{ title: "Value" }],
        searching: false, ordering:  false,
    	paging: false, info: false,
    });

    //Process overallresults
  
	var items = [];
    var cols = overallresults.cols;
    var _x  = function(data, type, row){ return data ? "&#x2713;": "&#x2715; <b>Fail</b>"; }
    for (c in cols){
	  cols[c].render = _x
    }
    cols[0].render =  linkToTestRepoAndFilter;
  
	Object.keys(overallresults.results).map(function(key, index) {
	   //Only bother with the ones containng failures
	   var rs = overallresults.results[key]
	   for (var i =1 ; i < rs.length ; i++){
	   	if (!rs[i]){
		   items.push(overallresults.results[key]);
		   break;
	   	}
	   }
	});
    $("#summary").DataTable({
    	data : items,
    	columns : cols,
    	
    });

    // Lastly, check any URL directives

    var params = utils.get_hash_params()
    if(params.execfilter){
    	execfilter(params.execfilter);
    }
    if(params.summaryfilter){
    	$('#summary').dataTable().api()
    		.search(params.summaryfilter).draw();
    }
    if(params.displayLog){
    	
    	displayLog(params.displayLog);
    }

}
</script>
</html>

<!-- 
Lovingly handcrafted by Martin Holst Swende @mhswende in 2017 
-->
