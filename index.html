<!DOCTYPE html>
<html lang="en">
<head>
	<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="crossorigin="anonymous"></script>
	<script src="jquery.dataTables.min.js"></script>
	<script src="dataTables.bootstrap.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="dataTables.bootstrap.min.css">

</head>
  
<body>
	<div class="container">
		<div class="row">
			<div class="col-9-md" role="main">
				<h1>Test report</h1>
				<h2>Execution info</h2>
				<table class="table table-bordered" id="metadata">
				</table>
				<h2>Execution results</h2>
				<table id="example" class="table table-striped table-bordered" width="100%">
				</table>
			</div>
			<div class="col-md-3" role="complementary"></div>
		</div>
	</div>

</body>
<script>

utils = {

	html_encode : function (str)
		{
			//Let the DOM do it for us. 
			var d = document.createElement('textarea');
			d.innerText = str;
			//Yes, I'm aware of 
			// http://stackoverflow.com/questions/1219860/html-encoding-in-javascript-jquery
			// I just don't agree. 
			return d.innerHTML;
		},

	attr_encode : function (str)
		{	
			// A bit more tricky. 
			x = document.createElement("x");
			x.setAttribute("b",str);
			var all = x.outerHTML;
			return all.substring(6,all.length-6);
			//but not much
		}
}

function recurseList(elem){
	if (typeof(elem) == 'string'){
		return "<li>"+utils.html_encode(elem)+"</li>"
	}
	return "<ul>" + elem.map(recurseList).join("\n")+"</ul>"
}

$(document).ready(function() {

	$.get( "data.json", onData)
	.fail(function(){
			//Ok, try to get jsonp-data instead
			var script = document.createElement('script');
			script.src = "data.jsonp";
			document.head.appendChild(script);
		}
	);
});

function onData(data){


	var items = []
	var meta = []
	var testtype = "blocktests/testrunner"; 
	var logfile_root = "simulations/blocktests:testrunner"
	for (client in data){


		performed_test = data[client][testtype];

		if (!performed_test) continue;
		

		meta.push([client +" start time", performed_test.start]);
		meta.push([client +" end time", performed_test.start]);
		meta.push(["Simulator log file", '<a href="'+logfile_root+'['+client+']/simulator.log">'+client+'</a>']);
		

		var x = performed_test.subresults.map(function(subresult){
			return { 
				"filename" 	: subresult.name,
			 	"status" 	: subresult.success,
				"client"	: client,
				"instance"	: subresult.details.instanceid,
				"message" 	: subresult.details.errors,
			}			
		});
		items = items.concat(x)
	}

   $('#example').DataTable( {
        data: items,
        pageLength: 100,
        columns: [
            { title: "Filename", data: "filename" },
            { title: "Status", data: "status" },
            { title: "Client", data: "client" },
            { title: "instance", data: "instance" , 
	           	render: function ( data, type, row ) {
     				   	if(!data) { return ""};
            			var a = document.createElement('a');
            			a.setAttribute("href",
            				logfile_root+
            				"["+client+"]/client-"+
            				data+".log");

            			a.text = data;
            			return a.outerHTML;
    			}},
            { title: "Message", data: "message", 
            	render: function ( data, type, row ) {
     				   if(!data) { return ""};
     				   return recurseList(data);

    			}, 
        },
        ],

        fnRowCallback: function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
        	var _s = {"false" : "danger", "true": "success"}[aData.status];
        	$(nRow).addClass( _s || "info")
			return nRow;
		},

    });

    $("#metadata").DataTable({
    	data : meta,
    	columns: [{ title: "Key" },{ title: "Value" }],
        searching: false, ordering:  false,
    	paging: false, info: false,
    });

}
</script>
</html>

<!-- 
Lovingly handcrafted by Martin Holst Swende @mhswende in 2017 
-->